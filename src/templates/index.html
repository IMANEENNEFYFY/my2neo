{% extends 'base.html' %}

{% block title %}Convertisseur MySQL → Neo4j{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="card-title text-primary text-center">Convertisseur MySQL → Neo4j</h2>
          <p class="text-center text-muted">Téléversez un fichier SQL et convertissez sa structure et ses données en un graphe Neo4j.</p>

          <form id="convertForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Fichier SQL</label>
              <input class="form-control" type="file" name="sql_file" required />
            </div>

            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label class="form-label">MySQL - Hôte</label>
                <input class="form-control" type="text" name="mysql_host" value="localhost" required />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">MySQL - Base</label>
                <input class="form-control" type="text" name="mysql_db" value="test" required />
              </div>
            </div>

            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label class="form-label">MySQL - Utilisateur</label>
                <input class="form-control" type="text" name="mysql_user" value="root" required />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">MySQL - Mot de passe</label>
                <input class="form-control" type="password" name="mysql_password" />
              </div>
            </div>

            <div class="row g-2">
              <div class="col-md-7 mb-3">
                <label class="form-label">Neo4j - URI</label>
                <input class="form-control" type="text" name="neo4j_uri" value="bolt://localhost:7687" required />
              </div>
              <div class="col-md-5 mb-3">
                <label class="form-label">Neo4j - Utilisateur</label>
                <input class="form-control" type="text" name="neo4j_user" value="neo4j" required />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Neo4j - Mot de passe</label>
              <input class="form-control" type="password" name="neo4j_password" required />
            </div>

            <div class="d-grid">
              <button class="btn btn-primary">Lancer la conversion</button>
            </div>
          </form>

          <div class="mt-4">
            <div class="progress">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
            </div>
            <div id="messageBox" class="mt-3 text-muted small"></div>
          </div>

        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const form = document.getElementById('convertForm');
    const progressBar = document.getElementById('progressBar');
    const messageBox = document.getElementById('messageBox');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      messageBox.textContent = '';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';

      const formData = new FormData(form);

      fetch('/start_conversion', { method:'POST', body:formData })
      .then(() => {
        const interval = setInterval(async () => {
          try {
            const res = await fetch('/progress');
            const data = await res.json();
            progressBar.style.width = data.percent + '%';
            progressBar.textContent = data.percent + '%';
            messageBox.textContent = data.message || '';

            if (data.percent >= 100) {
              clearInterval(interval);
              window.location.href = "/results";
            }
          } catch (err) {
            clearInterval(interval);
            messageBox.textContent = 'Erreur de communication: ' + err.message;
          }
        }, 600);
      }).catch(err => {
        messageBox.textContent = 'Erreur de démarrage: ' + err.message;
      });

    });
  </script>
{% endblock %}
