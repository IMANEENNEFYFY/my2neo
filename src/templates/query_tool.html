{% extends 'base.html' %}

{% block title %}Outil Requête — My2Neo{% endblock %}

{% block content %}
<div class="row g-4 align-items-stretch">

  <!-- SQL Panel -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm w-100 h-100 border-0" style="background:white;">
      <div class="card-body d-flex flex-column" style="min-height:350px;">
        <h5 class="card-title text-primary fw-bold">SQL</h5>
        <p class="text-primary small">Entrez votre requête SQL. Les identifiants MySQL sont affichés ci-dessous.</p>

        <form method="post" class="d-flex flex-column">
          <div class="mb-3">
            <label class="form-label fw-semibold text-primary">Requête SQL</label>
            <textarea id="sql_query" name="sql_query" class="form-control flex-fill" style="min-height:160px; max-height:36vh;">{{ sql or '' }}</textarea>
          </div>

          <div class="mb-3 small text-primary">
            MySQL: <strong>{{ last_conn.mysql.host|default('localhost') }}</strong> •
            DB: <strong>{{ last_conn.mysql.db|default('test') }}</strong> •
            User: <strong>{{ last_conn.mysql.user|default('root') }}</strong>
          </div>

          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="fillExample()">Exemple</button>
            <button type="submit" class="btn btn-primary">Exécuter SQL</button>
          </div>

          <!-- Hidden inputs -->
          <input type="hidden" name="mysql_host" value="{{ last_conn.mysql.host|default('localhost') }}">
          <input type="hidden" name="mysql_user" value="{{ last_conn.mysql.user|default('root') }}">
          <input type="hidden" name="mysql_db" value="{{ last_conn.mysql.db|default('test') }}">
          <input type="hidden" name="mysql_password" value="{{ last_conn.mysql.password|default('') }}">
          <input type="hidden" name="neo4j_uri" value="{{ last_conn.neo4j.uri|default('bolt://localhost:7687') }}">
          <input type="hidden" name="neo4j_user" value="{{ last_conn.neo4j.user|default('neo4j') }}">
          <input type="hidden" name="neo4j_password" value="{{ last_conn.neo4j.password|default('') }}">
        </form>

        {% if error %}
          <div class="alert alert-primary mt-3">{{ error }}</div>
        {% endif %}

        {% if sql_result %}
          <div class="mt-3 d-flex flex-column flex-fill">
            <div class="small text-primary mb-2">Résultat SQL — Temps: {{ '%.3f'|format(sql_time) }}s</div>
            <div class="table-responsive flex-fill" style="overflow:auto;">
              <table class="table table-sm table-bordered align-middle">
                <thead class="table-primary">
                  <tr>{% for c in sql_result.columns %}<th>{{ c }}</th>{% endfor %}</tr>
                </thead>
                <tbody>
                  {% for r in sql_result.rows %}
                    <tr class="table-light">{% for c in sql_result.columns %}<td>{{ r[c] }}</td>{% endfor %}</tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Cypher Panel -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm w-100 h-100 border-0" style="background:white;">
      <div class="card-body d-flex flex-column" style="min-height:350px;">
        <h5 class="card-title text-primary fw-bold">Cypher</h5>
        <p class="text-primary small">Traduction automatique de la requête SQL.</p>

        {% if cypher %}
          <div class="mb-2 flex-fill d-flex flex-column">
            <pre id="cypherBox" class="p-3 mb-2 bg-light border border-primary rounded flex-fill" style="max-height:28vh; overflow:auto;">{{ cypher }}</pre>
            <button class="btn btn-outline-primary btn-sm align-self-start" onclick="copyCypher()">Copier Cypher</button>
          </div>
        {% else %}
          <div class="alert alert-primary">Aucune traduction disponible pour cette requête.</div>
        {% endif %}

        {% if cypher_result %}
          <div class="mt-3 d-flex flex-column flex-fill">
            <div class="small text-primary mb-2">Résultat Cypher — Temps: {{ '%.3f'|format(cypher_time) }}s</div>
            <div class="table-responsive flex-fill" style="overflow:auto;">
              <table class="table table-sm table-bordered align-middle">
                <thead class="table-primary">
                  <tr>{% for k in (cypher_result.rows[0].keys() if cypher_result.rows else []) %}<th>{{ k }}</th>{% endfor %}</tr>
                </thead>
                <tbody>
                  {% for r in cypher_result.rows %}
                    <tr class="table-light">{% for k in (cypher_result.rows[0].keys() if cypher_result.rows else []) %}<td>{{ r[k] }}</td>{% endfor %}</tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function fillExample() {
  document.getElementById('sql_query').value = "SELECT * FROM users WHERE id = 1 LIMIT 10";
}
function copyCypher() {
  const txt = document.getElementById('cypherBox')?.innerText || '';
  if (!txt) return;
  navigator.clipboard.writeText(txt).then(() => alert('Cypher copié dans le presse-papiers'));
}
</script>
{% endblock %}
